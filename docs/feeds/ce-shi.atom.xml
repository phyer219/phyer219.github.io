<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>从冰上的水 - 测试</title><link href="https://zqw.ink/" rel="alternate"/><link href="https://zqw.ink/feeds/ce-shi.atom.xml" rel="self"/><id>https://zqw.ink/</id><updated>2025-12-21T00:00:00+08:00</updated><entry><title>测试</title><link href="https://zqw.ink/2025-12-21-coding-test.html" rel="alternate"/><published>2025-12-21T00:00:00+08:00</published><updated>2025-12-21T00:00:00+08:00</updated><author><name>ZQW</name></author><id>tag:zqw.ink,2025-12-21:/2025-12-21-coding-test.html</id><summary type="html">&lt;h2&gt;SSL加密&lt;/h2&gt;
&lt;p&gt;在使用自己搭建的服务，如 &lt;code&gt;emby&lt;/code&gt; ,&lt;code&gt;nextcloud&lt;/code&gt;, &lt;code&gt;immich&lt;/code&gt; 时，如果使用域名访问，当没有进行受信任的 SSL 加密时，对应的手机 app 会连不上，提醒，或 …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;SSL加密&lt;/h2&gt;
&lt;p&gt;在使用自己搭建的服务，如 &lt;code&gt;emby&lt;/code&gt; ,&lt;code&gt;nextcloud&lt;/code&gt;, &lt;code&gt;immich&lt;/code&gt; 时，如果使用域名访问，当没有进行受信任的 SSL 加密时，对应的手机 app 会连不上，提醒，或报错。&lt;/p&gt;
&lt;p&gt;最简单的方式是用 &lt;code&gt;certbot&lt;/code&gt; 获取一个 90 天期限的 SSL 证书，到期后再更新。此篇博客做一备忘。&lt;/p&gt;
&lt;h2&gt;证书获取过程&lt;/h2&gt;
&lt;p&gt;安装好certbot后，执行以下命令手动获取 SSL 证书，并用在域名上添加一条 txt 解析的方式进行域名验证：&lt;/p&gt;
&lt;pre&gt;&lt;code class="language-shell"&gt;certbot certonly --manual --preferred-challenges dns -d xxx.xxx.com
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;按提示在域名提供商处添加记录：&lt;/p&gt;
&lt;pre&gt;&lt;code class="language-shell"&gt;Saving debug log to /var/log/letsencrypt/letsencrypt.log
Requesting a certificate for xxx.xxx.com

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please deploy a DNS TXT record under the name:

_acme-challenge.xxx.xxx.com.

with the following value:

GxxxxxxxxxxxxxQ

Before continuing, verify the TXT record has been deployed. Depending on the DNS
provider, this may take some time, from a few seconds to multiple minutes. You can
check if it has finished deploying with aid of online tools, such as the Google
Admin Toolbox: https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.xxx.xxx.com.
Look for one or more bolded line(s) below the line ';ANSWER'. It should show the
value(s) you've just added.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Press Enter to Continue

Successfully received certificate.
Certificate is saved at: /etc/letsencrypt/live/xxx.xxx.com/fullchain.pem
Key is saved at:         /etc/letsencrypt/live/xxx.xxx.com/privkey.pem
This certificate expires on 2025-12-13.
These files will be updated when the certificate renews.

NEXT STEPS:
- This certificate will not be renewed automatically. Autorenewal of --manual certificates requires the use of an authentication hook script (--manual-auth-hook) but one was not provided. To renew this certificate, repeat this same certbot command before the certificate's expiry date.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
If you like Certbot, please consider supporting our work by:
 * Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
 * Donating to EFF:                    https://eff.org/donate-le
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;.pem&lt;/code&gt;、&lt;code&gt;.crt&lt;/code&gt;、&lt;code&gt;.key&lt;/code&gt; 本质上都是文本格式的证书/密钥文件，只是扩展名不同而已。可以直接需要复制或改名：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;fullchain.pem -&amp;gt;.crt
privkey.pem -&amp;gt;.key
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;正确设置权限，参考如下：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;-rw-r--r--. 1 zqw zqw 2.8K Sep 14 17:40 server.crt
-rw-------. 1 zqw zqw  227 Sep 14 17:40 server.key
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;代理的 Podman 文件，代理容器的配置文件示例&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;nextcloud-proxy.container&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class="language-shell"&gt;[Container]
ContainerName=nextcloud-proxy
Pod=nextcloud.pod
Image=docker.io/library/httpd:2.4
Volume=/xxx/extra-proxy.conf:/usr/local/apache2/conf/extra/proxy.conf:ro,Z
Volume=/xxx/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro,Z
Volume=/xxx/server.crt:/usr/local/apache2/conf/server.crt:ro,Z
Volume=/xxx/server.key:/usr/local/apache2/conf/server.key:ro,Z
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;httpd.conf&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class="language-shell"&gt;# Real-time info on requests and configuration
#Include conf/extra/httpd-info.conf

# Virtual hosts
#Include conf/extra/httpd-vhosts.conf

# Local access to the Apache HTTP Server Manual
#Include conf/extra/httpd-manual.conf

# Distributed authoring and versioning (WebDAV)
#Include conf/extra/httpd-dav.conf

# Various default settings
#Include conf/extra/httpd-default.conf

# Configure mod_proxy_html to understand HTML4/XHTML1
&amp;lt;IfModule proxy_html_module&amp;gt;
Include conf/extra/proxy-html.conf
&amp;lt;/IfModule&amp;gt;

# Secure (SSL/TLS) connections
#Include conf/extra/httpd-ssl.conf
#
# Note: The following must must be present to support
#       starting without SSL on platforms with no /dev/random equivalent
#       but a statically compiled-in mod_ssl.
#
&amp;lt;IfModule ssl_module&amp;gt;
SSLRandomSeed startup builtin
SSLRandomSeed connect builtin
&amp;lt;/IfModule&amp;gt;

Include conf/extra/proxy.conf
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;反向代理容器和 nextcloud 容器在同个 pod 内，把nextcloud 默认的 80 代理到了 443:&lt;/p&gt;
&lt;pre&gt;&lt;code class="language-shell"&gt;LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so

&amp;lt;IfModule mod_proxy.c&amp;gt;
    ProxyPreserveHost On
    ProxyPass / http://localhost:80/
    ProxyPassReverse / http://localhost:80/
&amp;lt;/IfModule&amp;gt;

LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
LoadModule ssl_module modules/mod_ssl.so
Include conf/extra/httpd-ssl.conf
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;在 &lt;code&gt;~/.config/containers/systemd/nextcloud.pod&lt;/code&gt; 文件中，再把 443 映射到想要的端口（如9999），这样就可能在外网通过 SSL 访问 NextCloud 容器:&lt;/p&gt;
&lt;pre&gt;&lt;code class="language-shell"&gt;
[Pod]
PodName=nextcloud
Network=bridge
PublishPort=9999:443

[Install]
WantedBy=default.target
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://wiki.archlinux.org/title/Certbot"&gt;ArchWiki: Certbot&lt;/a&gt;&lt;/p&gt;</content><category term="测试"/><category term="SSL"/><category term="certbot"/></entry></feed>