<!DOCTYPE html>
<html lang="zh_cn">

<head>
    <meta charset="utf-8" />
  <title>从冰上的水 - 用 certbot 手动获取受信任的 SSL证，并实现对 NextCloud 容器80端口的SSL访问</title>
  <meta name="generator" content="Pelican" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
    href="https://zqw.ink/feeds/all.atom.xml"
    type="application/atom+xml" rel="alternate" title="从冰上的水 Full Atom Feed" />
      <link
    href="https://zqw.ink/feeds/ruan-jian-shi-yong.atom.xml"
    type="application/atom+xml" rel="alternate" title="从冰上的水 Categories Atom Feed" />
     <link rel="stylesheet" type="text/css" href="https://zqw.ink/theme/css/style.css" />
  <!-- fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Long+Cang&family=Noto+Serif+SC&display=swap" rel="stylesheet" />
  <!--fonts end  -->
  <!-- highlight.js -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <!-- highlight.js end -->

<script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.1">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.1">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.1">




    <meta name="tags" content="SSL" />
    <meta name="tags" content="certbot" />

</head>

<body class="star-background">
  <div class="container">
    <header>
      <section class="banner">
        <img id="banner-img" src="/images/banner.jpg" alt="banner-img" />
      </section>
    </header>
    <nav class="row">
      <a class="nav" href="/">首页</a>
      <a class="nav" href="/categories.html">分类</a>
      <a class="nav" href="/tags.html">标签</a>
        <a class="nav" href="https://zqw.ink/pages/about.html" aria-current="page">
        关于
      </a>
     </nav>

    <main>
  <h1 class="post-title">用 certbot 手动获取受信任的 SSL证，并实现对 NextCloud 容器80端口的SSL访问</h1>

<section class="post-meta">
    <p>发表于: 2025-09-14 ||</p>
    <p>分类:<a class="post-link" href="https://zqw.ink/category/ruan-jian-shi-yong.html">软件使用</a> ||</p>
</section>

<section class="post-content">
  <h2>SSL加密</h2>
<p>在使用自己搭建的服务，如 <code>emby</code> ,<code>nextcloud</code>, <code>immich</code> 时，如果使用域名访问，当没有进行受信任的 SSL 加密时，对应的手机 app 会连不上，提醒，或报错。</p>
<p>最简单的方式是用 <code>certbot</code> 获取一个 90 天期限的 SSL 证书，到期后再更新。此篇博客做一备忘。</p>
<h2>证书获取过程</h2>
<p>安装好certbot后，执行以下命令手动获取 SSL 证书，并用在域名上添加一条 txt 解析的方式进行域名验证：</p>
<pre><code class="language-shell">certbot certonly --manual --preferred-challenges dns -d xxx.xxx.com
</code></pre>
<p>按提示在域名提供商处添加记录：</p>
<pre><code class="language-shell">Saving debug log to /var/log/letsencrypt/letsencrypt.log
Requesting a certificate for xxx.xxx.com

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please deploy a DNS TXT record under the name:

_acme-challenge.xxx.xxx.com.

with the following value:

GxxxxxxxxxxxxxQ

Before continuing, verify the TXT record has been deployed. Depending on the DNS
provider, this may take some time, from a few seconds to multiple minutes. You can
check if it has finished deploying with aid of online tools, such as the Google
Admin Toolbox: https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.xxx.xxx.com.
Look for one or more bolded line(s) below the line ';ANSWER'. It should show the
value(s) you've just added.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Press Enter to Continue

Successfully received certificate.
Certificate is saved at: /etc/letsencrypt/live/xxx.xxx.com/fullchain.pem
Key is saved at:         /etc/letsencrypt/live/xxx.xxx.com/privkey.pem
This certificate expires on 2025-12-13.
These files will be updated when the certificate renews.

NEXT STEPS:
- This certificate will not be renewed automatically. Autorenewal of --manual certificates requires the use of an authentication hook script (--manual-auth-hook) but one was not provided. To renew this certificate, repeat this same certbot command before the certificate's expiry date.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
If you like Certbot, please consider supporting our work by:
 * Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
 * Donating to EFF:                    https://eff.org/donate-le
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</code></pre>
<p><code>.pem</code>、<code>.crt</code>、<code>.key</code> 本质上都是文本格式的证书/密钥文件，只是扩展名不同而已。可以直接需要复制或改名：</p>
<pre><code>fullchain.pem -&gt;.crt
privkey.pem -&gt;.key
</code></pre>
<p>正确设置权限，参考如下：</p>
<pre><code>-rw-r--r--. 1 zqw zqw 2.8K Sep 14 17:40 server.crt
-rw-------. 1 zqw zqw  227 Sep 14 17:40 server.key
</code></pre>
<h2>代理的 Podman 文件，代理容器的配置文件示例</h2>
<p><code>nextcloud-proxy.container</code>:</p>
<pre><code class="language-shell">[Container]
ContainerName=nextcloud-proxy
Pod=nextcloud.pod
Image=docker.io/library/httpd:2.4
Volume=/xxx/extra-proxy.conf:/usr/local/apache2/conf/extra/proxy.conf:ro,Z
Volume=/xxx/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro,Z
Volume=/xxx/server.crt:/usr/local/apache2/conf/server.crt:ro,Z
Volume=/xxx/server.key:/usr/local/apache2/conf/server.key:ro,Z
</code></pre>
<p><code>httpd.conf</code></p>
<pre><code class="language-shell"># Real-time info on requests and configuration
#Include conf/extra/httpd-info.conf

# Virtual hosts
#Include conf/extra/httpd-vhosts.conf

# Local access to the Apache HTTP Server Manual
#Include conf/extra/httpd-manual.conf

# Distributed authoring and versioning (WebDAV)
#Include conf/extra/httpd-dav.conf

# Various default settings
#Include conf/extra/httpd-default.conf

# Configure mod_proxy_html to understand HTML4/XHTML1
&lt;IfModule proxy_html_module&gt;
Include conf/extra/proxy-html.conf
&lt;/IfModule&gt;

# Secure (SSL/TLS) connections
#Include conf/extra/httpd-ssl.conf
#
# Note: The following must must be present to support
#       starting without SSL on platforms with no /dev/random equivalent
#       but a statically compiled-in mod_ssl.
#
&lt;IfModule ssl_module&gt;
SSLRandomSeed startup builtin
SSLRandomSeed connect builtin
&lt;/IfModule&gt;

Include conf/extra/proxy.conf
</code></pre>
<p>反向代理容器和 nextcloud 容器在同个 pod 内，把nextcloud 默认的 80 代理到了 443:</p>
<pre><code class="language-shell">LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so

&lt;IfModule mod_proxy.c&gt;
    ProxyPreserveHost On
    ProxyPass / http://localhost:80/
    ProxyPassReverse / http://localhost:80/
&lt;/IfModule&gt;

LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
LoadModule ssl_module modules/mod_ssl.so
Include conf/extra/httpd-ssl.conf
</code></pre>
<p>在 <code>~/.config/containers/systemd/nextcloud.pod</code> 文件中，再把 443 映射到想要的端口（如9999），这样就可能在外网通过 SSL 访问 NextCloud 容器:</p>
<pre><code class="language-shell">
[Pod]
PodName=nextcloud
Network=bridge
PublishPort=9999:443

[Install]
WantedBy=default.target
</code></pre>
<h2>参考</h2>
<p><a href="https://wiki.archlinux.org/title/Certbot">ArchWiki: Certbot</a></p>
</section>

<section class="post-meta">
    <p>标签:
        <a class="post-link" href="https://zqw.ink/tag/ssl.html">SSL</a>
        <a class="post-link" href="https://zqw.ink/tag/certbot.html">certbot</a>
    </p>
</section>

    </main>
    <footer>© 2018 - 2025 ZQW</footer>
  </div>
</body>

</html>